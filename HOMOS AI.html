<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HOMOS AI</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
body { font-family: 'Noto Sans Arabic', sans-serif; }
.loader {
  width:18px;height:18px;border:3px solid #6366f1;
  border-bottom-color:transparent;border-radius:50%;
  animation:spin 1s linear infinite
}
@keyframes spin { to { transform: rotate(360deg) } }
</style>
</head>

<body class="bg-[#0b1020] text-white h-screen flex flex-col">

<header class="p-4 border-b border-white/10 flex justify-between items-center">
  <h1 class="font-bold text-lg">HOMOS AI</h1>
  <span class="text-xs opacity-40">Advanced AI Assistant</span>
</header>

<div id="chat" class="flex-1 overflow-y-auto p-4 space-y-6"></div>

<div class="p-4 border-t border-white/10">
  <div class="flex gap-2 items-end bg-[#11162a] p-3 rounded-xl">

    <input type="file" id="file" hidden accept="image/*" onchange="handleFile(this)">
    <button onclick="document.getElementById('file').click()">
      <i data-lucide="image"></i>
    </button>

    <textarea id="prompt" rows="1" placeholder="اسأل HOMOS AI..."
      class="flex-1 bg-transparent resize-none outline-none"
      oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>

    <button onclick="send()" class="bg-indigo-600 p-2 rounded-lg">
      <i data-lucide="send"></i>
    </button>
  </div>
</div>

<script>
/* ========= إعدادات ========= */
const apiKey = "AIzaSyCAYty5_UQ32usD_p-DpLtlHamVnD3btM4";
const MODEL = "gemini-1.5-flash-latest";

const SYSTEM_PROMPT = `
أنت HOMOS AI.
مساعد ذكاء اصطناعي عربي متقدم.
تم تطويرك وتخصيصك بواسطة Mohamed Homos.
لا تذكر Google أو Gemini.
`;

let base64Image = null;
let memory = JSON.parse(localStorage.getItem("homos_memory")) || [];

lucide.createIcons();

/* ========= تحميل الذاكرة ========= */
memory.forEach(m => addMessage(m.role, m.text));

/* ========= حفظ الذاكرة ========= */
function saveMemory() {
  localStorage.setItem("homos_memory", JSON.stringify(memory));
}

/* ========= صورة ========= */
function handleFile(input){
  const file = input.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e => base64Image = e.target.result.split(",")[1];
  reader.readAsDataURL(file);
}

/* ========= إرسال ========= */
async function send(){
  const input = document.getElementById("prompt");
  const text = input.value.trim();
  if(!text && !base64Image) return;

  addMessage("user", text);
  memory.push({ role: "user", text });
  saveMemory();

  input.value = "";
  const loadingId = addLoading();

  await callHomosAI(loadingId);
}

/* ========= الاتصال ========= */
async function callHomosAI(loadingId){

  const contents = [
    { role: "system", parts: [{ text: SYSTEM_PROMPT }] },
    ...memory.map(m => ({
      role: m.role,
      parts: [{ text: m.text }]
    }))
  ];

  const res = await fetch(
    `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${apiKey}`,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ contents })
    }
  );

  const data = await res.json();

  if (data.error) {
    updateMessage(loadingId, "❌ " + data.error.message);
    return;
  }

  const reply = data.candidates[0].content.parts[0].text;

  updateMessage(loadingId, reply);
  memory.push({ role: "model", text: reply });
  saveMemory();
}

/* ========= UI ========= */
function addMessage(role, text){
  const chat = document.getElementById("chat");
  const div = document.createElement("div");
  div.className = "flex gap-3 " + (role === "user" ? "flex-row-reverse" : "");
  div.innerHTML = `
    <div class="w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center">
      ${role === "user" ? "أنت" : "AI"}
    </div>
    <div class="bg-white/5 p-4 rounded-xl max-w-xl">${text}</div>
  `;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function addLoading(){
  const id = "load-" + Date.now();
  addMessage("model", "HOMOS AI يفكر...");
  return id;
}

function updateMessage(_, text){
  const last = document.querySelectorAll(".bg-white\\/5");
  last[last.length - 1].innerText = text;
}
</script>

</body>
</html>

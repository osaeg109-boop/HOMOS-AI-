import React, { useState, useEffect, useRef } from 'react';
import { 
  Send, Menu, Plus, MessageSquare, Settings, User, Sparkles, X, 
  Moon, Sun, Copy, Check, Image as ImageIcon, Upload, Wand2, 
  Loader2, Camera, Download
} from 'lucide-react';

const apiKey = ""; 
const TEXT_MODEL = "gemini-2.5-flash-preview-09-2025";
const IMAGE_EDIT_MODEL = "gemini-2.5-flash-image-preview";

const App = () => {
  const [messages, setMessages] = useState([
    { 
      id: 'welcome', 
      role: 'assistant', 
      content: 'مرحباً بك في HOMOS AI! أنا الآن أدعم تحليل الصور وتعديلها. يمكنك رفع صورة وسؤالي عنها أو طلب تعديلها مباشرة. \n\n تم تطوير هذا النموذج بواسطة: **Mohamed Homos**' 
    }
  ]);
  const [inputValue, setInputValue] = useState('');
  const [isSidebarOpen, setIsSidebarOpen] = useState(false);
  const [isTyping, setIsTyping] = useState(false);
  const [darkMode, setDarkMode] = useState(true);
  const [selectedImage, setSelectedImage] = useState(null);
  const [previewUrl, setPreviewUrl] = useState(null);
  const [copiedId, setCopiedId] = useState(null);

  const messagesEndRef = useRef(null);
  const fileInputRef = useRef(null);

  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages, isTyping]);

  const handleFileChange = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setSelectedImage(reader.result.split(',')[1]); // Base64 data
        setPreviewUrl(reader.result);
      };
      reader.readAsDataURL(file);
    }
  };

  const fetchWithRetry = async (url, payload, retries = 5, delay = 1000) => {
    try {
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      return await response.json();
    } catch (err) {
      if (retries > 0) {
        await new Promise(res => setTimeout(res, delay));
        return fetchWithRetry(url, payload, retries - 1, delay * 2);
      }
      throw err;
    }
  };

  const handleSendMessage = async () => {
    if ((!inputValue.trim() && !selectedImage) || isTyping) return;

    const userText = inputValue.trim();
    const currentImage = selectedImage;
    const currentPreview = previewUrl;

    const userMsg = { 
      id: Date.now(), 
      role: 'user', 
      content: userText,
      image: currentPreview 
    };

    setMessages(prev => [...prev, userMsg]);
    setInputValue('');
    setSelectedImage(null);
    setPreviewUrl(null);
    setIsTyping(true);

    try {
      let aiResponse;
      
      // التمييز بين طلب تعديل صورة أو مجرد دردشة/تحليل
      const isEditRequest = userText.includes("عدل") || userText.includes("تعديل") || userText.includes("edit");

      if (isEditRequest && currentImage) {
        // استخدام موديل تعديل الصور
        const payload = {
          contents: [{
            parts: [
              { text: userText || "Edit this image" },
              { inlineData: { mimeType: "image/png", data: currentImage } }
            ]
          }],
          generationConfig: { responseModalities: ['TEXT', 'IMAGE'] }
        };
        const result = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/${IMAGE_EDIT_MODEL}:generateContent?key=${apiKey}`, payload);
        const base64Image = result.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
        const textDesc = result.candidates?.[0]?.content?.parts?.find(p => p.text)?.text || "تم تعديل الصورة بنجاح!";
        
        aiResponse = {
          id: Date.now() + 1,
          role: 'assistant',
          content: textDesc,
          image: base64Image ? `data:image/png;base64,${base64Image}` : null
        };
      } else {
        // استخدام موديل النصوص/الرؤية للتحليل
        const payload = {
          contents: [{
            parts: [
              { text: userText || "ماذا يوجد في هذه الصورة؟" },
              ...(currentImage ? [{ inlineData: { mimeType: "image/png", data: currentImage } }] : [])
            ]
          }],
          systemInstruction: { parts: [{ text: "أنت HOMOS AI، مطور بواسطة Mohamed Homos. أنت خبير في تحليل الصور وتقديم إجابات دقيقة ونموذجية باللغة العربية." }] }
        };
        const result = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${apiKey}`, payload);
        aiResponse = {
          id: Date.now() + 1,
          role: 'assistant',
          content: result.candidates?.[0]?.content?.parts?.[0]?.text || "عذراً، لم أتمكن من المعالجة."
        };
      }

      setMessages(prev => [...prev, aiResponse]);
    } catch (err) {
      setMessages(prev => [...prev, { id: Date.now(), role: 'assistant', content: "حدث خطأ أثناء معالجة طلبك. يرجى التأكد من جودة الصورة والمحاولة مرة أخرى." }]);
    } finally {
      setIsTyping(false);
    }
  };

  const themeClasses = darkMode ? 'bg-[#0b0f1a] text-slate-100' : 'bg-gray-50 text-slate-900';

  return (
    <div className={`flex h-screen w-full font-sans overflow-hidden ${themeClasses}`} dir="rtl">
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans Arabic', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
      `}</style>

      {/* Sidebar */}
      <aside className={`fixed md:relative z-40 w-72 h-full border-l transition-all duration-300 ${isSidebarOpen ? 'translate-x-0' : 'translate-x-full md:translate-x-0'} ${darkMode ? 'bg-[#070a13] border-slate-800' : 'bg-white border-slate-200'}`}>
        <div className="p-6">
          <div className="flex items-center gap-3 mb-8">
            <div className="p-2 bg-indigo-600 rounded-lg shadow-lg shadow-indigo-500/30">
              <Sparkles className="text-white" size={24} />
            </div>
            <span className="text-xl font-bold tracking-tight">HOMOS AI</span>
          </div>
          <button onClick={() => setMessages([messages[0]])} className="w-full flex items-center justify-center gap-2 p-3 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white transition-all shadow-lg mb-6">
            <Plus size={18} />
            <span>محادثة جديدة</span>
          </button>
        </div>

        <div className="flex-1 px-4 text-sm opacity-60">
           <div className="p-4 rounded-xl border border-dashed border-slate-700">
              <p className="mb-2 font-bold">حول النموذج:</p>
              <p>تم تصميم هذا النظام ليكون مساعدك الشخصي في معالجة الصور والنصوص.</p>
              <p className="mt-4 text-indigo-400">المطور: Mohamed Homos</p>
           </div>
        </div>

        <div className="p-4 mt-auto">
          <button onClick={() => setDarkMode(!darkMode)} className="flex items-center gap-3 w-full p-3 rounded-xl hover:bg-slate-800/50 transition-colors">
            {darkMode ? <Sun size={20} className="text-yellow-500" /> : <Moon size={20} />}
            <span>{darkMode ? 'الوضع النهاري' : 'الوضع الليلي'}</span>
          </button>
        </div>
      </aside>

      {/* Main Content */}
      <main className="flex-1 flex flex-col min-w-0 relative">
        <header className="h-16 flex items-center justify-between px-6 border-b border-white/5">
          <button onClick={() => setIsSidebarOpen(true)} className="md:hidden"><Menu /></button>
          <div className="flex items-center gap-2">
            <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
            <span className="text-xs font-medium opacity-50">نظام Mohamed Homos نشط</span>
          </div>
          <div className="w-8 h-8 rounded-full bg-indigo-600/20 border border-indigo-500/30 flex items-center justify-center text-indigo-400 font-bold">H</div>
        </header>

        <div className="flex-1 overflow-y-auto p-4 md:p-8 space-y-8 no-scrollbar">
          {messages.map((msg) => (
            <div key={msg.id} className={`flex gap-4 max-w-4xl mx-auto ${msg.role === 'user' ? 'flex-row-reverse' : 'flex-row'}`}>
              <div className={`w-10 h-10 rounded-xl flex items-center justify-center flex-shrink-0 ${msg.role === 'user' ? 'bg-slate-800' : 'bg-indigo-600 text-white'}`}>
                {msg.role === 'user' ? <User size={20} /> : <Sparkles size={20} />}
              </div>
              <div className={`flex flex-col gap-2 max-w-[85%] ${msg.role === 'user' ? 'items-end' : 'items-start'}`}>
                <div className={`px-5 py-4 rounded-2xl text-sm md:text-base ${msg.role === 'user' ? 'bg-indigo-600 text-white' : (darkMode ? 'bg-slate-800/50 border border-white/5' : 'bg-white shadow-sm border border-slate-100')}`}>
                  {msg.image && (
                    <div className="mb-3 rounded-lg overflow-hidden border border-white/10">
                       <img src={msg.image} alt="uploaded" className="max-h-64 w-auto object-contain" />
                    </div>
                  )}
                  <div className="whitespace-pre-wrap leading-relaxed">{msg.content}</div>
                </div>
              </div>
            </div>
          ))}
          {isTyping && (
            <div className="flex gap-4 max-w-4xl mx-auto items-start">
               <div className="w-10 h-10 rounded-xl bg-indigo-600 flex items-center justify-center text-white shadow-lg"><Loader2 className="animate-spin" size={20} /></div>
               <div className="px-6 py-4 rounded-2xl bg-slate-800/50 border border-white/5 text-sm">جاري المعالجة بواسطة HOMOS AI...</div>
            </div>
          )}
          <div ref={messagesEndRef} />
        </div>

        {/* Input Area */}
        <div className="p-4 md:p-8">
          <div className="max-w-4xl mx-auto">
            {previewUrl && (
              <div className="mb-4 relative inline-block">
                <img src={previewUrl} className="h-24 w-24 object-cover rounded-xl border-2 border-indigo-500 shadow-xl" />
                <button onClick={() => {setPreviewUrl(null); setSelectedImage(null);}} className="absolute -top-2 -left-2 bg-red-500 text-white rounded-full p-1 shadow-lg">
                  <X size={14} />
                </button>
              </div>
            )}
            <div className={`relative flex items-end gap-2 p-2 rounded-2xl border transition-all ${darkMode ? 'bg-[#161b2c] border-white/10 focus-within:border-indigo-500' : 'bg-white border-slate-200 focus-within:border-indigo-500 shadow-xl'}`}>
              <button onClick={() => fileInputRef.current.click()} className="p-3 text-slate-400 hover:text-indigo-500 transition-colors">
                <ImageIcon size={22} />
              </button>
              <input type="file" ref={fileInputRef} hidden accept="image/*" onChange={handleFileChange} />
              
              <textarea
                value={inputValue}
                onChange={(e) => setInputValue(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && !e.shiftKey && (e.preventDefault(), handleSendMessage())}
                placeholder={previewUrl ? "اطلب تعديل الصورة أو اسأل عنها..." : "اسأل HOMOS AI..."}
                rows={1}
                className="w-full bg-transparent border-none focus:ring-0 p-3 text-sm md:text-base resize-none"
                style={{ minHeight: '50px', maxHeight: '150px' }}
              />
              
              <button
                onClick={handleSendMessage}
                disabled={(!inputValue.trim() && !selectedImage) || isTyping}
                className={`p-3 rounded-xl transition-all ${(!inputValue.trim() && !selectedImage) || isTyping ? 'opacity-20' : 'bg-indigo-600 text-white hover:scale-105 shadow-lg shadow-indigo-500/20'}`}
              >
                {isTyping ? <Loader2 className="animate-spin" size={20} /> : <Send size={20} />}
              </button>
            </div>
            <p className="text-[10px] text-center mt-3 opacity-30">HOMOS AI Vision Engine v3.0 | Created by Mohamed Homos</p>
          </div>
        </div>
      </main>
    </div>
  );
};

export default App;

